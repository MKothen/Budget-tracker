<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        :root {
            --bg-primary: #111827; /* slate-900 */
            --bg-secondary: #1f2937; /* slate-800 */
            --border-color: #374151; /* slate-700 */
            --text-primary: #f3f4f6; /* gray-200 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent: #8b5cf6; /* violet-500 */
            --accent-hover: #7c3aed; /* violet-600 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 120px; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: rgba(31, 41, 55, 0.5); color: var(--text-secondary); }
        .modal, #auth-container { display: none; }
        .modal.active, #auth-container.active { display: flex; }
        #app-container.hidden { display: none; }
        .progress-bar { background-color: var(--border-color); border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; }
        .calendar-day { min-width: 0; }
        .transaction-list { overflow: hidden; }
        .transaction-item { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .input-field { background-color: #374151; border: 1px solid #4b5563; color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--accent); ring: 1; ring-color: var(--accent); }
        .card { background-color: var(--bg-secondary); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: #374151; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #4b5563; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Overlay -->
    <div id="auth-container" class="active fixed inset-0 bg-slate-900 items-center justify-center p-4">
        <div class="card p-8 w-full max-w-sm">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-white">Login</h2>
            <form id="auth-form">
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-400">Email</label><input type="email" id="email" class="input-field mt-1 block w-full px-3 py-2 rounded-md shadow-sm" required></div>
                <div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-400">Password</label><input type="password" id="password" class="input-field mt-1 block w-full px-3 py-2 rounded-md shadow-sm" required></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-md transition-colors">Login</button>
            </form>
            <p id="auth-error" class="text-red-400 text-sm mt-4 text-center"></p>
            <p class="text-sm text-center mt-4"><a href="#" id="auth-toggle" class="font-medium text-violet-400 hover:text-violet-300">Need an account? Sign up</a></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
         <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8 relative">
                <h1 class="text-3xl font-bold text-white">Finance Dashboard</h1>
                <p class="text-gray-400 mt-1">Your financial overview, simplified.</p>
                <button data-action="logout" class="absolute top-0 right-0 bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm transition-colors">Logout</button>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <main class="lg:col-span-2 card p-6">
                    <div id="calendar-container">
                        <div class="flex items-center justify-between mb-6"><button data-action="prev-month" class="btn-secondary px-3 py-1 rounded-md">&lt;</button><h2 id="current-month-year" class="text-xl font-semibold"></h2><button data-action="next-month" class="btn-secondary px-3 py-1 rounded-md">&gt;</button></div>
                        <div class="calendar-grid grid-cols-7 text-center font-semibold text-gray-400 text-sm mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                        <div id="calendar-body" class="calendar-grid border-t border-l border-slate-700"></div>
                    </div>
                </main>
                <aside class="space-y-8">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Monthly Summary</h3>
                        <div id="summary-container" class="space-y-3"></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Expense Breakdown</h3>
                        <div class="w-full h-56 flex items-center justify-center"><canvas id="expense-chart"></canvas></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Savings Goals</h3>
                        <div id="savings-goals-list" class="space-y-4"></div>
                        <button data-action="add-goal" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Goal</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Monthly Budgets</h3>
                        <div id="recurring-expenses-list" class="space-y-4"></div>
                        <button data-action="add-budget" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Budget</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Automatic Monthly Bills</h3>
                        <div id="automatic-bills-list" class="space-y-2"></div>
                         <button data-action="add-bill" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Bill</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Settings</h3>
                        <div class="space-y-4"><div><label for="hourly-rate" class="block text-sm font-medium text-gray-400 mb-1">Your Hourly Rate (€)</label><input type="number" id="hourly-rate" class="input-field w-full px-3 py-2 rounded-md shadow-sm" placeholder="e.g., 15.50" step="0.01"></div><div><label for="initial-balance" class="block text-sm font-medium text-gray-400 mb-1">Initial Balance (€)</label><input type="number" id="initial-balance" class="input-field w-full px-3 py-2 rounded-md shadow-sm" placeholder="e.g., 500.00" step="0.01"></div><button data-action="save-settings" class="w-full btn-primary py-2 px-4 rounded-md transition-colors">Save Settings</button></div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 id="modal-title" class="text-xl font-semibold mb-6">Add Transaction</h3><form id="transaction-form"><input type="hidden" id="transaction-date"><input type="hidden" id="transaction-id"><div class="mb-4"><div class="flex rounded-md shadow-sm"><button type="button" data-action="set-tx-type" data-type="income" id="type-income" class="flex-1 py-2 px-4 border border-slate-700 bg-slate-800 rounded-l-md focus:outline-none">Income</button><button type="button" data-action="set-tx-type" data-type="expense" id="type-expense" class="flex-1 py-2 px-4 border border-slate-700 bg-slate-800 rounded-r-md focus:outline-none -ml-px">Expense</button></div></div><div id="income-source-group" class="mb-4 hidden"><label class="block text-sm font-medium text-gray-400 mb-2">Income Type</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="income-source" value="other" class="focus:ring-violet-500 h-4 w-4 text-violet-600 bg-slate-700 border-slate-600" checked><span class="ml-2 text-sm">Fixed Amount</span></label><label class="flex items-center"><input type="radio" name="income-source" value="work" class="focus:ring-violet-500 h-4 w-4 text-violet-600 bg-slate-700 border-slate-600"><span class="ml-2 text-sm">Work (by hours)</span></label></div></div><div id="category-group" class="mb-4 hidden"><label for="category" class="block text-sm font-medium text-gray-400">Category</label><select id="category" class="input-field mt-1 block w-full px-3 py-2 rounded-md"></select></div><div class="mb-4"><label for="description" class="block text-sm font-medium text-gray-400">Description</label><input type="text" id="description" class="input-field mt-1 block w-full px-3 py-2 rounded-md" required></div><div id="amount-group" class="mb-4"><label for="amount" class="block text-sm font-medium text-gray-400">Amount (€)</label><input type="number" id="amount" class="input-field mt-1 block w-full px-3 py-2 rounded-md" step="0.01" required></div><div id="hours-group" class="mb-4 hidden"><label for="hours" class="block text-sm font-medium text-gray-400">Hours Worked</label><input type="number" id="hours" class="input-field mt-1 block w-full px-3 py-2 rounded-md" step="0.1"><p class="text-sm text-gray-500 mt-1">Calculated Income: <span id="calculated-income" class="font-semibold">€0.00</span></p></div><div class="flex justify-end space-x-3 mt-8"><button type="button" data-action="delete-transaction" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">Delete</button><button type="button" data-action="close-modal" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Save</button></div></form></div>
    </div>
    <div id="budget-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Budget</h3><form id="budget-form"><input type="hidden" id="budget-id"><div class="mb-4"><label for="budget-description" class="block text-sm font-medium text-gray-400">Description</label><input type="text" id="budget-description" placeholder="e.g., Groceries" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="budget-amount" class="block text-sm font-medium text-gray-400">Monthly Budget (€)</label><input type="number" id="budget-amount" placeholder="e.g., 300" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" data-action="close-modal" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Save Budget</button></div></form></div>
    </div>
    <div id="goal-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Savings Goal</h3><form id="goal-form"><input type="hidden" id="goal-id"><div class="mb-4"><label for="goal-description" class="block text-sm font-medium text-gray-400">Goal Name</label><input type="text" id="goal-description" placeholder="e.g., Vacation Fund" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="goal-amount" class="block text-sm font-medium text-gray-400">Target Amount (€)</label><input type="number" id="goal-amount" placeholder="e.g., 1000" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" data-action="close-modal" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Save Goal</button></div></form></div>
    </div>
    <div id="contribute-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Contribute to Goal</h3><form id="contribute-form"><input type="hidden" id="contribute-goal-id"><div class="mb-4"><label for="contribute-amount" class="block text-sm font-medium text-gray-400">Amount to Contribute (€)</label><input type="number" id="contribute-amount" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" data-action="close-modal" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Contribute</button></div></form></div>
    </div>
    <div id="bill-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Automatic Bill</h3><form id="bill-form"><input type="hidden" id="bill-id"><div class="mb-4"><label for="bill-description" class="block text-sm font-medium text-gray-400">Bill Name</label><input type="text" id="bill-description" placeholder="e.g., Rent" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="bill-amount" class="block text-sm font-medium text-gray-400">Amount (€)</label><input type="number" id="bill-amount" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="mb-4"><label for="bill-day" class="block text-sm font-medium text-gray-400">Day of Month</label><input type="number" id="bill-day" class="input-field mt-1 w-full px-3 py-2 rounded-md" min="1" max="31" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" data-action="close-modal" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Save Bill</button></div></form></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {"apiKey":"AIzaSyDzeI6mMuICNJdO_G2F7fiGFlQhyo8RWM8","authDomain":"budgeting-b3974.firebaseapp.com","projectId":"budgeting-b3974","storageBucket":"budgeting-b3974.appspot.com","messagingSenderId":"462817466291","appId":"1:462817466291:web:13260b80355f9d0b559dc6"};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE MANAGEMENT ---
        const state = {
            currentDate: dayjs(),
            transactions: {},
            settings: { hourlyRate: '', initialBalance: 0, recurringExpenses: [], savingsGoals: [], automaticBills: [] },
            user: null,
            unsubscribe: null,
            expenseChart: null,
            isLogin: true
        };

        const $ = (selector) => document.getElementById(selector);

        // --- RENDER FUNCTIONS (UI LOGIC) ---
        async function render() {
            if (!state.user) return;
            await addAutomaticBillsForMonth();
            renderCalendar();
            renderSummary();
            renderBudgets();
            renderGoals();
            renderBills();
            renderChart();
        }

        function renderCalendar() {
            const calendarBody = $('calendar-body');
            calendarBody.innerHTML = '';
            $('current-month-year').textContent = state.currentDate.format('MMMM YYYY');
            const month = state.currentDate.month(), year = state.currentDate.year(), firstDayOfMonth = state.currentDate.startOf('month').day(), daysInMonth = state.currentDate.daysInMonth();
            let html = Array.from({length: firstDayOfMonth}, (_, i) => createDayCell(state.currentDate.startOf('month').subtract(firstDayOfMonth - i, 'day').format('YYYY-MM-DD'), true)).join('');
            html += Array.from({length: daysInMonth}, (_, i) => createDayCell(state.currentDate.date(i + 1).format('YYYY-MM-DD'))).join('');
            const totalCells = firstDayOfMonth + daysInMonth;
            const nextMonthDays = (7 - (totalCells % 7)) % 7;
            html += Array.from({length: nextMonthDays}, (_, i) => createDayCell(state.currentDate.endOf('month').add(i + 1, 'day').format('YYYY-MM-DD'), true)).join('');
            calendarBody.innerHTML = html;
            renderTransactionsOnCalendar();
        }

        function createDayCell(dateStr, isOtherMonth = false) {
            const day = dayjs(dateStr).date();
            const today = dayjs().format('YYYY-MM-DD');
            let dayClass = 'calendar-day relative p-2 border-r border-b border-slate-700';
            if (!isOtherMonth) dayClass += ' hover:bg-slate-700 cursor-pointer'; else dayClass += ' other-month';
            const dayNumberHtml = dateStr === today ? `<div class="absolute top-1 right-1 text-xs sm:text-sm bg-violet-600 text-white rounded-full h-6 w-6 flex items-center justify-center font-semibold">${day}</div>` : `<div class="text-xs sm:text-sm text-right text-gray-400">${day}</div>`;
            return `<div class="${dayClass}" data-date="${dateStr}" data-action="add-transaction">${dayNumberHtml}<div class="transaction-list mt-8 text-xs space-y-1"></div></div>`;
        }
        
        function renderTransactionsOnCalendar() {
            for (const date in state.transactions) {
                const dayCell = document.querySelector(`.calendar-day[data-date="${date}"]`);
                if (dayCell) {
                    const list = dayCell.querySelector('.transaction-list');
                    list.innerHTML = state.transactions[date].map(t => `<div class="transaction-item p-1 rounded text-white ${t.type === 'income' ? 'bg-green-600' : (t.category?.startsWith('goal_') ? 'bg-blue-600' : 'bg-red-600')}" data-id="${t.id}" data-date="${date}" data-action="edit-transaction" title="${t.description}: €${t.amount.toFixed(2)}">${t.description}</div>`).join('');
                }
            }
        }
        
        function renderSummary() {
            const { totalIncome, totalExpenses, net, cashFlow } = calculateSummary();
            $('summary-container').innerHTML = `<div class="flex justify-between items-center"><span class="text-gray-400">Income:</span><span class="font-bold text-green-400">€${totalIncome.toFixed(2)}</span></div><div class="flex justify-between items-center"><span class="text-gray-400">Expenses:</span><span class="font-bold text-red-400">€${totalExpenses.toFixed(2)}</span></div><hr class="border-slate-700"><div class="flex justify-between items-center text-lg"><span class="font-semibold">Net:</span><span class="font-bold ${net >= 0 ? 'text-green-400' : 'text-red-400'}">€${net.toFixed(2)}</span></div><div class="flex justify-between items-center text-lg"><span class="font-semibold">Cash Flow:</span><span class="font-bold ${cashFlow >= 0 ? 'text-gray-200' : 'text-red-400'}">€${cashFlow.toFixed(2)}</span></div>`;
        }

        function renderBudgets() { const list = $('recurring-expenses-list'); if (!state.settings.recurringExpenses?.length) { list.innerHTML = `<p class="text-sm text-center text-gray-400">No budgets set.</p>`; return; } const monthlyTransactions = Object.values(state.transactions).flat().filter(t => dayjs(t.date).month() === state.currentDate.month() && dayjs(t.date).year() === state.currentDate.year()); list.innerHTML = state.settings.recurringExpenses.map(b => { const spent = monthlyTransactions.filter(t => t.category === b.id).reduce((acc, t) => acc + t.amount, 0); const p = b.amount > 0 ? (spent / b.amount) * 100 : 0; const c = p > 100 ? 'bg-red-500' : p > 75 ? 'bg-yellow-500' : 'bg-green-500'; return `<div class="bg-slate-800 p-3 rounded-md"><div class="flex justify-between items-center mb-2"><p class="font-medium">${b.description}</p><div class="flex space-x-2"><button class="text-sm font-medium text-violet-400 hover:text-violet-300" data-action="edit-budget" data-id="${b.id}">Edit</button><button class="text-sm font-medium text-red-400 hover:text-red-300" data-action="delete-budget" data-id="${b.id}">Del</button></div></div><div class="text-sm text-gray-400 mb-2"><span>Spent: €${spent.toFixed(2)}</span> / <span>€${b.amount.toFixed(2)}</span></div><div class="progress-bar h-2 w-full"><div class="progress-bar-inner ${c}" style="width: ${Math.min(p, 100)}%;"></div></div></div>`; }).join(''); }
        function renderGoals() { const list = $('savings-goals-list'); if (!state.settings.savingsGoals?.length) { list.innerHTML = `<p class="text-sm text-center text-gray-400">No goals set.</p>`; return; } const allTransactions = Object.values(state.transactions).flat(); list.innerHTML = state.settings.savingsGoals.map(g => { const saved = allTransactions.filter(t => t.category === `goal_${g.id}`).reduce((acc, t) => acc + t.amount, 0); const p = g.target > 0 ? (saved / g.target) * 100 : 0; return `<div class="bg-slate-800 p-3 rounded-md"><div class="flex justify-between items-center mb-2"><p class="font-medium">${g.description}</p><div class="flex space-x-2"><button class="text-sm font-medium text-green-400 hover:text-green-300" data-action="contribute-goal" data-id="${g.id}">Add</button><button class="text-sm font-medium text-violet-400 hover:text-violet-300" data-action="edit-goal" data-id="${g.id}">Edit</button><button class="text-sm font-medium text-red-400 hover:text-red-300" data-action="delete-goal" data-id="${g.id}">Del</button></div></div><div class="text-sm text-gray-400 mb-2"><span>Saved: €${saved.toFixed(2)}</span> / <span>€${g.target.toFixed(2)}</span></div><div class="progress-bar h-2 w-full"><div class="progress-bar-inner bg-blue-500" style="width: ${Math.min(p, 100)}%;"></div></div></div>`; }).join(''); }
        function renderBills() { const list = $('automatic-bills-list'); if (!state.settings.automaticBills?.length) { list.innerHTML = `<p class="text-sm text-center text-gray-400">No bills set.</p>`; return; } list.innerHTML = state.settings.automaticBills.map(b => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded-md text-sm"><p>${b.description} - €${b.amount} on day ${b.day}</p><div class="flex space-x-2"><button class="text-sm font-medium text-violet-400 hover:text-violet-300" data-action="edit-bill" data-id="${b.id}">Edit</button><button class="text-sm font-medium text-red-400 hover:text-red-300" data-action="delete-bill" data-id="${b.id}">Del</button></div></div>`).join(''); }
        function renderChart() { const ctx = $('expense-chart').getContext('2d'); const { expenseData } = calculateSummary(); if (state.expenseChart) state.expenseChart.destroy(); state.expenseChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(expenseData), datasets: [{ data: Object.values(expenseData), backgroundColor: ['#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#6366f1'], borderColor: '#1f2937', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } }); }

        // --- CALCULATIONS ---
        function calculateSummary() {
            const month = state.currentDate.month(), year = state.currentDate.year();
            let totalIncome = 0, oneTimeExpenses = 0, expenseData = {};
            const monthlyTransactions = Object.values(state.transactions).flat().filter(t => dayjs(t.date).month() === month && dayjs(t.date).year() === year);
            monthlyTransactions.forEach(t => {
                if (t.type === 'income') { totalIncome += t.amount; }
                else { 
                    let categoryName = "One-Time";
                    if (t.category === 'one-time') oneTimeExpenses += t.amount;
                    else if (t.category?.startsWith('goal_')) { const goal = state.settings.savingsGoals.find(g => g.id === t.category.split('_')[1]); if(goal) categoryName = `Goal: ${goal.description}`; }
                    else { const budget = state.settings.recurringExpenses.find(b => b.id === t.category); if(budget) categoryName = budget.description; }
                    expenseData[categoryName] = (expenseData[categoryName] || 0) + t.amount;
                }
            });
            const totalBudgetedExpenses = (state.settings.recurringExpenses || []).reduce((acc, item) => acc + item.amount, 0);
            const totalExpenses = oneTimeExpenses + totalBudgetedExpenses;
            const net = totalIncome - totalExpenses;
            let cashFlow = parseFloat(state.settings.initialBalance) || 0;
            Object.values(state.transactions).flat().sort((a,b) => dayjs(a.date).diff(dayjs(b.date))).forEach(t => { if (!dayjs(t.date).isAfter(dayjs(), 'day')) cashFlow += t.type === 'income' ? t.amount : -t.amount; });
            return { totalIncome, totalExpenses, net, cashFlow, expenseData };
        }

        // --- GLOBAL EVENT CONTROLLER ---
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id, date, type } = target.dataset;
            switch(action) {
                case 'logout': signOut(auth); break;
                case 'prev-month': state.currentDate = state.currentDate.subtract(1, 'month'); render(); break;
                case 'next-month': state.currentDate = state.currentDate.add(1, 'month'); render(); break;
                case 'save-settings': saveSettings().then(() => alert('Settings saved!')); break;
                case 'add-transaction': openTransactionModal(date); break;
                case 'edit-transaction': openTransactionModal(date, id); break;
                case 'delete-transaction': handleDeleteTransaction(); break;
                case 'add-budget': openBudgetModal(); break;
                case 'edit-budget': openBudgetModal(id); break;
                case 'delete-budget': if(confirm('Delete budget?')){ state.settings.recurringExpenses = state.settings.recurringExpenses.filter(i => i.id !== id); saveSettings().then(render); } break;
                case 'add-goal': openGoalModal(); break;
                case 'edit-goal': openGoalModal(id); break;
                case 'delete-goal': if(confirm('Delete goal?')){ state.settings.savingsGoals = state.settings.savingsGoals.filter(i => i.id !== id); saveSettings().then(render); } break;
                case 'contribute-goal': openContributeModal(id); break;
                case 'add-bill': openBillModal(); break;
                case 'edit-bill': openBillModal(id); break;
                case 'delete-bill': if(confirm('Delete bill?')){ state.settings.automaticBills = state.settings.automaticBills.filter(i => i.id !== id); saveSettings().then(render); } break;
                case 'close-modal': closeModal(); break;
                case 'set-tx-type': setTransactionTypeUI(type); break;
            }
        });

        document.addEventListener('submit', e => {
            e.preventDefault();
            switch(e.target.id) {
                case 'auth-form': handleAuthForm(e); break;
                case 'transaction-form': handleTransactionSubmit(e); break;
                case 'budget-form': handleBudgetSubmit(e); break;
                case 'goal-form': handleGoalSubmit(e); break;
                case 'bill-form': handleBillSubmit(e); break;
                case 'contribute-form': handleContributeSubmit(e); break;
            }
        });
        
        // --- MODAL & FORM LOGIC ---
        function openTransactionModal(date, id=null) {
            const form = $('transaction-form'); form.reset();
            $('transaction-date').value = date; $('transaction-id').value = id || '';
            let type = 'expense', category = 'one-time';
            if (id) {
                const t = state.transactions[date]?.find(tx => tx.id === id);
                if (t) { $('modal-title').textContent = 'Edit Transaction'; $('description').value = t.description; $('amount').value = t.amount; type = t.type; category = t.category; $('delete-transaction').classList.remove('hidden'); }
            } else { $('modal-title').textContent = `Add Transaction for ${dayjs(date).format('MMMM D, YYYY')}`; $('delete-transaction').classList.add('hidden'); }
            setTransactionTypeUI(type, category);
            $('transaction-modal').classList.add('active');
        }
        async function handleTransactionSubmit(e) { const form=e.target, id=form['transaction-id'].value, date=form['transaction-date'].value, description=form['description'].value; let amount=parseFloat(form['amount'].value); let type=$('type-income').classList.contains('bg-violet-600')?'income':'expense', category='one-time', hours=null, source=null; if(type==='income'){ source=form['income-source'].value; if(source==='work'){ hours=parseFloat(form['hours'].value); if(isNaN(hours)||hours<=0)return alert('Invalid hours.'); amount=hours*(parseFloat(state.settings.hourlyRate)||0); } }else{ category=form['category'].value; } if(!description||isNaN(amount)||amount<=0)return alert('Invalid input.'); const newTx={date,description,amount,type,category,hours,source}; const ref=collection(db,'users',state.user.uid,'transactions'); if(id)await updateDoc(doc(ref,id),newTx); else await addDoc(ref,newTx); closeModal(); }
        async function handleDeleteTransaction() { const id = $('transaction-id').value; if(confirm('Delete transaction?')) { await deleteDoc(doc(db, 'users', state.user.uid, 'transactions', id)); closeModal(); }}
        function openBudgetModal(id=null) { $('budget-form').reset(); $('budget-id').value = id || ''; if (id) { const b = state.settings.recurringExpenses.find(i=>i.id===id); if(b){ $('budget-description').value = b.description; $('budget-amount').value = b.amount; }} $('budget-modal').classList.add('active'); }
        function handleBudgetSubmit(e) { const desc=$('budget-description').value,amount=parseFloat($('budget-amount').value),id=$('budget-id').value||Date.now().toString(); if(!desc||isNaN(amount)||amount<=0)return; const idx=state.settings.recurringExpenses.findIndex(i=>i.id===id); if(idx>-1)state.settings.recurringExpenses[idx]={id,description:desc,amount}; else state.settings.recurringExpenses.push({id,description:desc,amount}); saveSettings().then(()=>{render();closeModal();}); }
        function openGoalModal(id=null) { $('goal-form').reset(); $('goal-id').value = id || ''; if(id){ const g = state.settings.savingsGoals.find(i=>i.id===id); if(g){ $('goal-description').value = g.description; $('goal-amount').value = g.target; }} $('goal-modal').classList.add('active'); }
        function handleGoalSubmit(e) { const desc=$('goal-description').value,amount=parseFloat($('goal-amount').value),id=$('goal-id').value||Date.now().toString(); if(!desc||isNaN(amount)||amount<=0)return; const idx=state.settings.savingsGoals.findIndex(i=>i.id===id); if(idx>-1){state.settings.savingsGoals[idx].description=desc;state.settings.savingsGoals[idx].target=amount;}else state.settings.savingsGoals.push({id,description:desc,target:amount}); saveSettings().then(()=>{render();closeModal();}); }
        function openBillModal(id=null) { $('bill-form').reset(); $('bill-id').value = id || ''; if(id){ const b = state.settings.automaticBills.find(i=>i.id===id); if(b){ $('bill-description').value = b.description; $('bill-amount').value = b.amount; $('bill-day').value = b.day; }} $('bill-modal').classList.add('active'); }
        function handleBillSubmit(e) { const desc=$('bill-description').value,amount=parseFloat($('bill-amount').value),day=parseInt($('bill-day').value),id=$('bill-id').value||Date.now().toString(); if(!desc||isNaN(amount)||amount<=0||isNaN(day)||day<1||day>31)return alert('Invalid input'); const idx=state.settings.automaticBills.findIndex(i=>i.id===id); if(idx>-1)state.settings.automaticBills[idx]={id,description:desc,amount,day}; else state.settings.automaticBills.push({id,description:desc,amount,day}); saveSettings().then(()=>{render();closeModal();}); }
        function openContributeModal(id) { $('contribute-form').reset(); $('contribute-goal-id').value = id; $('contribute-modal').classList.add('active'); }
        async function handleContributeSubmit(e) { const goalId=$('contribute-goal-id').value,amount=parseFloat($('contribute-amount').value); if(isNaN(amount)||amount<=0)return; const goal=state.settings.savingsGoals.find(g=>g.id===goalId); if(!goal)return; const newTx={date:dayjs().format('YYYY-MM-DD'),description:`Contribution to ${goal.description}`,amount,type:'expense',category:`goal_${goalId}`}; await addDoc(collection(db,'users',state.user.uid,'transactions'),newTx); closeModal(); }
        function setTransactionTypeUI(type, category = 'one-time') { const incomeBtn = $('type-income'), expenseBtn = $('type-expense'); if (type === 'income') { incomeBtn.classList.add('bg-violet-600', 'text-white'); expenseBtn.classList.remove('bg-violet-600', 'text-white'); $('income-source-group').classList.remove('hidden'); $('category-group').classList.add('hidden'); } else { expenseBtn.classList.add('bg-violet-600', 'text-white'); incomeBtn.classList.remove('bg-violet-600', 'text-white'); $('income-source-group').classList.add('hidden'); $('category-group').classList.remove('hidden'); const select = $('category'); select.innerHTML = '<option value="one-time">One-Time Expense</option>'; state.settings.recurringExpenses.forEach(item => { select.innerHTML += `<option value="${item.id}">${item.description}</option>`; }); select.value = category; }}
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        
        async function addAutomaticBillsForMonth() { if(!state.user || !state.settings.automaticBills) return; for(const bill of state.settings.automaticBills) { let billDay = bill.day > state.currentDate.daysInMonth() ? state.currentDate.daysInMonth() : bill.day; const billDate = state.currentDate.date(billDay).format('YYYY-MM-DD'); const desc = `Auto-Bill: ${bill.description}`; const q = query(collection(db, 'users', state.user.uid, 'transactions'), where("date", "==", billDate), where("description", "==", desc)); const existing = await getDocs(q); if(existing.empty) { addDoc(collection(db, 'users', state.user.uid, 'transactions'), { date: billDate, description: desc, amount: bill.amount, type: 'expense', category: 'one-time' }); } } }
        
        async function handleAuthForm(e) { const email = $('email').value, password = $('password').value; $('auth-error').textContent = ''; try { if (state.isLogin) await signInWithEmailAndPassword(auth, email, password); else await createUserWithEmailAndPassword(auth, email, password); } catch (error) { $('auth-error').textContent = error.message; }}
        function toggleAuthMode(e) { e.preventDefault(); state.isLogin = !state.isLogin; $('auth-title').textContent = state.isLogin ? 'Login' : 'Sign Up'; $('auth-button').textContent = state.isLogin ? 'Login' : 'Create Account'; $('auth-toggle').textContent = state.isLogin ? 'Need an account? Sign up' : 'Have an account? Login'; $('auth-error').textContent = ''; }
        
        // --- APP INITIALIZATION ---
        $('auth-toggle').addEventListener('click', toggleAuthMode);
        onAuthStateChanged(auth, user => {
            if (user) {
                state.user = user;
                $('auth-container').classList.remove('active');
                $('app-container').classList.remove('hidden');
                if (state.unsubscribe) state.unsubscribe();
                const settingsRef = doc(db, 'users', user.uid);
                getDoc(settingsRef).then(docSnap => {
                    if (docSnap.exists() && docSnap.data().settings) {
                        const loaded = docSnap.data().settings;
                        state.settings = { hourlyRate: loaded.hourlyRate || '', initialBalance: loaded.initialBalance || 0, recurringExpenses: loaded.recurringExpenses || [], savingsGoals: loaded.savingsGoals || [], automaticBills: loaded.automaticBills || [] };
                        $('hourly-rate').value = state.settings.hourlyRate;
                        $('initial-balance').value = state.settings.initialBalance;
                    }
                    const transCollectionRef = collection(db, 'users', user.uid, 'transactions');
                    state.unsubscribe = onSnapshot(transCollectionRef, (snapshot) => { state.transactions = {}; snapshot.forEach(doc => { const t = { id: doc.id, ...doc.data() }; if (!state.transactions[t.date]) state.transactions[t.date] = []; state.transactions[t.date].push(t); }); render(); });
                });
            } else {
                state.user = null;
                $('auth-container').classList.add('active');
                $('app-container').classList.add('hidden');
                if (state.unsubscribe) state.unsubscribe();
            }
        });

    </script>
</body>
</html>



