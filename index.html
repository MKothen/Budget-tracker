<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Budget Dashboard â€” Final</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f5f7fa; --card:#fff; --muted:#6b7280; --text:#111827;
  --accent:#0ea5a4; --accent-strong:#08938c; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  --border:#e6eef0; --shadow:0 10px 30px rgba(2,6,23,0.08);
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;min-height:100vh}
.sidebar{width:250px;padding:20px;background:linear-gradient(180deg,#ffffff,#fbffff);border-right:1px solid var(--border);}
.brand{font-weight:700;color:var(--accent);font-size:18px;margin-bottom:6px}
.user-email{color:var(--muted);font-size:13px;word-break:break-all;margin-bottom:12px}
.nav-btn{display:block;width:100%;padding:8px 10px;border-radius:8px;border:none;background:transparent;text-align:left;color:var(--text);cursor:pointer;margin-bottom:6px}
.nav-btn:hover{background:rgba(0,0,0,0.03)}
.main{flex:1;padding:24px;overflow:auto}
.header{display:flex;justify-content:space-between;align-items:center}
.h-title{font-size:20px;font-weight:700}
.controls{display:flex;gap:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:var(--accent);color:white}
.btn-ghost{background:transparent;border:1px solid var(--border)}
.top-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:18px;margin-bottom:18px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border)}
.card h3{margin:0;color:var(--muted);font-size:13px;font-weight:600}
.amount{margin-top:8px;font-size:20px;font-weight:800}
.amount.positive{color:var(--good)}.amount.negative{color:var(--bad)}
.spend-today{font-size:22px;font-weight:900;margin-top:8px}
.calendar-wrap{display:grid;grid-template-columns:1fr 360px;gap:18px}
.calendar{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
.day{background:#fff;padding:8px;border-radius:8px;min-height:80px;border:1px solid var(--border);position:relative;overflow:hidden}
.day .num{font-weight:700;color:var(--muted);font-size:12px}
.transaction-pill{display:inline-block;padding:4px 8px;border-radius:999px;color:white;font-size:12px;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.transaction-pill.income{background:var(--good)}.transaction-pill.expense{background:var(--bad)}
.flash-income{animation:flashGreen 1s ease;} .flash-expense{animation:flashRed 1s ease;}
@keyframes flashGreen{0%{box-shadow:0 0 0 rgba(16,185,129,0.9)}50%{box-shadow:0 8px 30px rgba(16,185,129,0.06)}100%{box-shadow:none}}
@keyframes flashRed{0%{box-shadow:0 0 0 rgba(239,68,68,0.9)}50%{box-shadow:0 8px 30px rgba(239,68,68,0.06)}100%{box-shadow:none}}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:var(--card);padding:18px;border-radius:12px;width:90%;max-width:480px;box-shadow:var(--shadow);border:1px solid var(--border)}
.form-group{margin-bottom:12px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#fbfeff;font-size:14px}

/* small helpers */
.muted{color:var(--muted);font-size:13px}

/* responsive */
@media(max-width:900px){.calendar-wrap{grid-template-columns:1fr}.sidebar{display:none}}
</style>
</head>
<body>
<div id="app" class="app" style="display:none">
  <aside class="sidebar">
    <div class="brand">Budget Dashboard</div>
    <div id="user-email" class="user-email"></div>
    <button id="settings-btn" class="nav-btn">âš™ Settings</button>
    <button id="manage-budgets-btn" class="nav-btn">ðŸ—‚ Manage Budgets</button>
    <button id="logout-btn" class="nav-btn">Logout</button>
  </aside>

  <main class="main">
    <div class="header">
      <div><div class="h-title">Dashboard</div><div class="muted">Live, predictive budgeting</div></div>
      <div class="controls">
        <button id="add-tx" class="btn btn-primary">+ Transaction</button>
        <button id="add-goal" class="btn btn-ghost">+ Goal</button>
      </div>
    </div>

    <div class="top-grid">
      <div class="card" id="starting-card"><h3>Starting Balance</h3><div class="amount" id="starting-balance">â‚¬0.00</div></div>
      <div class="card"><h3>Monthly Net Flow</h3><div class="amount" id="net-flow">â‚¬0.00</div></div>
      <div class="card"><h3>Predicted End Balance</h3><div class="amount" id="end-balance">â‚¬0.00</div></div>
      <div class="card"><h3>You Can Spend Today</h3><div id="spend-today" class="spend-today">â‚¬0.00</div><div id="spend-warning" class="muted" style="margin-top:6px"></div></div>
    </div>

    <div class="calendar-wrap">
      <div class="calendar card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><button id="prev-month" class="btn btn-ghost">&lt;</button> <strong id="month-label"></strong> <button id="next-month" class="btn btn-ghost">&gt;</button></div>
          <div><select id="filter"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option><option value="recurring">Recurring</option></select></div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>

      <aside style="display:flex;flex-direction:column;gap:12px">
        <div class="card"><h3>Savings Goals</h3><div id="goals" class="muted" style="margin-top:8px">No goals yet.</div></div>
        <div class="card"><h3>Budgets</h3><div id="budgets" class="muted" style="margin-top:8px">No budgets yet.</div></div>
        <div class="card"><h3>Insights</h3><div id="insights" class="muted" style="margin-top:8px">No insights yet.</div></div>
      </aside>
    </div>
  </main>
</div>

<!-- auth UI simple -->
<div id="auth" style="height:100vh;display:flex;align-items:center;justify-content:center">
  <div class="card" style="max-width:400px;width:100%"><h2>Login</h2>
    <div class="form-group"><label>Email</label><input id="email" type="email"></div>
    <div class="form-group"><label>Password</label><input id="password" type="password"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button id="login" class="btn btn-primary">Login</button><button id="signup" class="btn btn-ghost">Sign Up</button></div>
    <div class="muted" style="margin-top:8px">Use email/password to persist your data.</div>
  </div>
</div>

<!-- transaction modal -->
<div id="tx-modal" class="modal-overlay" style="display:none"><div class="modal">
  <h3 id="tx-title">Add Transaction</h3>
  <form id="tx-form">
    <input type="hidden" id="tx-id">
    <div class="form-group"><label>Title</label><input id="tx-title-input" required></div>
    <div class="form-group"><label>Amount (â‚¬)</label><input id="tx-amount" type="number" step="0.01" required></div>
    <div class="form-group"><label>Category</label><input id="tx-cat"></div>
    <div class="form-group"><label>Type</label><select id="tx-type"><option value="expense">Expense</option><option value="income">Income</option></select></div>
    <div class="form-group"><label>Date</label><input id="tx-date" type="date" required></div>
    <div class="form-group"><label><input id="tx-rec" type="checkbox"> Recurring</label></div>
    <div class="form-group" id="rec-opts" style="display:none"><label>Frequency</label><select id="tx-freq"><option value="monthly">Monthly</option><option value="weekly">Weekly</option><option value="daily">Daily</option></select></div>
    <div style="display:flex;justify-content:space-between;align-items:center"><button id="tx-delete" type="button" class="btn btn-ghost" style="display:none">Delete</button><div style="display:flex;gap:8px"><button type="button" id="tx-cancel" class="btn btn-ghost">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></div>
  </form>
</div></div>

<!-- settings modal -->
<div id="settings-modal" class="modal-overlay" style="display:none"><div class="modal">
  <h3>Settings</h3>
  <form id="settings-form">
    <div class="form-group"><label>Currency Symbol</label><input id="cur" value="â‚¬"></div>
    <div class="form-group"><label>Monthly Savings Target (â‚¬)</label><input id="savings-target" type="number" step="0.01"></div>
    <div class="form-group"><label><input id="enable-ai" type="checkbox" checked> Enable Predictions</label></div>
    <div style="display:flex;justify-content:flex-end;gap:8px"><button id="settings-cancel" class="btn btn-ghost" type="button">Close</button><button class="btn btn-primary" type="submit">Save</button></div>
  </form>
</div></div>

<!-- goal modal -->
<div id="goal-modal" class="modal-overlay" style="display:none"><div class="modal">
  <h3>Add Goal</h3>
  <form id="goal-form">
    <div class="form-group"><label>Name</label><input id="goal-name" required></div>
    <div class="form-group"><label>Amount (â‚¬)</label><input id="goal-amount" type="number" step="0.01" required></div>
    <div style="display:flex;justify-content:flex-end;gap:8px"><button id="goal-cancel" class="btn btn-ghost" type="button">Close</button><button class="btn btn-primary" type="submit">Add</button></div>
  </form>
</div></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
/* Keep your firebase config exactly as requested */
const firebaseConfig = {apiKey: "AIzaSyDzeI6mMuICNJdO_G2F7fiGFlQhyo8RWM8",authDomain: "budgeting-b3974.firebaseapp.com",projectId: "budgeting-b3974",storageBucket: "budgeting-b3974.firebasestorage.app",messagingSenderId: "462817466291",appId: "1:462817466291:web:13260b80355f9d0b559dc6"};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* state */
let user = null;
let settings = {currency:'â‚¬',savingsTarget:0,enableAI:true};
let transactions = []; // will include virtual recurring ones in rendering
let rawTx = []; // actual stored transactions
let budgets = [];
let goals = [];
let currentDate = new Date();
let balanceChart = null;

/* elements */
const appEl = document.getElementById('app');
const authEl = document.getElementById('auth');
const userEmailEl = document.getElementById('user-email');
const monthLabel = document.getElementById('month-label');
const calendarGrid = document.getElementById('calendar-grid');
const startEl = document.getElementById('starting-balance');
const netEl = document.getElementById('net-flow');
const endEl = document.getElementById('end-balance');
const spendEl = document.getElementById('spend-today');
const warnEl = document.getElementById('spend-warning');

/* auth handlers */
auth.onAuthStateChanged(async (u)=>{
  if(u){ user=u; userEmailEl.textContent = u.email; authEl.style.display='none'; appEl.style.display='flex'; await loadSettings(); await fetchAll(); } else { user=null; appEl.style.display='none'; authEl.style.display='flex'; }
});

document.getElementById('login').addEventListener('click', ()=> auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e=>alert(e.message)));
document.getElementById('signup').addEventListener('click', ()=> auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e=>alert(e.message)));
document.getElementById('logout-btn').addEventListener('click', ()=> auth.signOut());

/* UI openers */
document.getElementById('add-tx').addEventListener('click', ()=> openTxModal());
document.getElementById('add-goal').addEventListener('click', ()=> document.getElementById('goal-modal').style.display='flex');
document.getElementById('settings-btn').addEventListener('click', async ()=> { await loadSettings(); document.getElementById('cur').value=settings.currency; document.getElementById('savings-target').value=settings.savingsTarget; document.getElementById('enable-ai').checked=settings.enableAI; document.getElementById('settings-modal').style.display='flex'; });
document.getElementById('manage-budgets-btn').addEventListener('click', ()=> document.getElementById('goal-modal').style.display='flex');

/* modal controls */
document.getElementById('tx-cancel').addEventListener('click', ()=> document.getElementById('tx-modal').style.display='none');
document.getElementById('tx-rec').addEventListener('change', (e)=> { document.getElementById('rec-opts').style.display = e.target.checked ? 'block' : 'none'; });
document.getElementById('settings-cancel').addEventListener('click', ()=> document.getElementById('settings-modal').style.display='none');
document.getElementById('goal-cancel').addEventListener('click', ()=> document.getElementById('goal-modal').style.display='none');
document.getElementById('tx-delete').addEventListener('click', async ()=> { const id=document.getElementById('tx-id').value; if(!id) return; if(!confirm('Delete?')) return; await db.collection('transactions').doc(id).delete(); document.getElementById('tx-modal').style.display='none'; await fetchAll(true); });

/* save settings */
document.getElementById('settings-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!user) return alert('Sign in');
  settings.currency = document.getElementById('cur').value || 'â‚¬';
  settings.savingsTarget = Number(document.getElementById('savings-target').value) || 0;
  settings.enableAI = document.getElementById('enable-ai').checked;
  await db.collection('settings').doc(user.uid).set({uid:user.uid,currency:settings.currency,savingsTarget:settings.savingsTarget,enableAI:settings.enableAI});
  document.getElementById('settings-modal').style.display='none';
  renderAll();
});

/* save goal */
document.getElementById('goal-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!user) return alert('Sign in');
  const g={uid:user.uid,name:document.getElementById('goal-name').value,amount:Number(document.getElementById('goal-amount').value)||0,createdAt:firebase.firestore.FieldValue.serverTimestamp()};
  await db.collection('savingsGoals').add(g);
  document.getElementById('goal-modal').style.display='none';
  await fetchAll(true);
});

/* tx save */
document.getElementById('tx-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!user) return alert('Sign in');
  const id=document.getElementById('tx-id').value;
  const payload={uid:user.uid,title:document.getElementById('tx-title-input').value,amount:Number(document.getElementById('tx-amount').value)||0,category:document.getElementById('tx-cat').value,type:document.getElementById('tx-type').value,date:document.getElementById('tx-date').value,isRecurring:document.getElementById('tx-rec').checked,recurrence:document.getElementById('tx-freq').value,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  try{
    if(id) await db.collection('transactions').doc(id).update(payload); else await db.collection('transactions').add({...payload,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById('tx-modal').style.display='none';
    await fetchAll(true);
  }catch(err){ alert('Save failed: '+err.message); }
});

/* fetch all relevant collections and render */
async function fetchAll(forceUpdate=false){
  if(!user) return;
  const year=currentDate.getFullYear(), month=currentDate.getMonth();
  // load settings, budgets, goals, transactions
  const [sDoc, txSnap, budSnap, goalSnap] = await Promise.all([db.collection('settings').doc(user.uid).get(), db.collection('transactions').where('uid','==',user.uid).get(), db.collection('budgets').where('uid','==',user.uid).where('year','==',year).where('month','==',month).get(), db.collection('savingsGoals').where('uid','==',user.uid).get()]);
  if(sDoc.exists) settings = {...settings, ...sDoc.data()};
  rawTx = txSnap.docs.map(d=>({id:d.id,...d.data()}));
  budgets = budSnap.docs.map(d=>({id:d.id,...d.data()}));
  goals = goalSnap.docs.map(d=>({id:d.id,...d.data()}));
  // construct transactions including virtual recurring occurrences within current month
  buildTransactionsForMonth(year,month);
  // update starting balance
  const startBal = await getStartingBalance(year,month);
  startEl.textContent = `${settings.currency}${startBal.toFixed(2)}`;
  // render calendar, summary, chart, goals, budgets, insights
  renderAll();
  // persist next month starting balance if forceUpdate (e.g., after tx change)
  if(forceUpdate){
    const endBal = computePredictedEnd(startBal);
    const next = new Date(year, month+1, 1); const nextKey=`${next.getFullYear()}-${String(next.getMonth()).padStart(2,'0')}`;
    await db.collection('monthlyOverrides').doc(`${user.uid}_${nextKey}`).set({startingBalance:endBal});
  }
}

/* Build transactions for current month including virtual recurring occurrences */
function buildTransactionsForMonth(year,month){
  transactions = [];
  const monthStart = new Date(year,month,1);
  const monthEnd = new Date(year,month+1,0);
  // include non-recurring transactions that are within month (and historical ones are kept for starting balance calc elsewhere)
  rawTx.forEach(t=>{
    // normalize amount
    t.amount = Number(t.amount)||0;
    // include all stored tx (we'll filter when rendering)
    // generate virtual occurrences for recurring ones
    if(t.isRecurring){
      let occ = new Date(t.date);
      // step forward/back to include occurrences falling into current month - allow past occurrences too
      // normalize occ to same day of month as original recurring start
      while(occ <= monthEnd){
        if(occ >= monthStart && occ <= monthEnd){
          const iso=occ.toISOString().split('T')[0];
          // avoid duplication if user already has a real tx on that date same title+amount
          const exists = rawTx.some(r=>r.title===t.title && Number(r.amount)===Number(t.amount) && r.date===iso);
          if(!exists) transactions.push({...t,date:iso,isVirtual:true,originalId:t.id});
        }
        if(t.recurrence==='monthly') occ.setMonth(occ.getMonth()+1);
        else if(t.recurrence==='weekly') occ.setDate(occ.getDate()+7);
        else if(t.recurrence==='daily') occ.setDate(occ.getDate()+1);
        else break;
      }
    }
    // include stored tx that fall into month
    if(t.date){
      const d = new Date(t.date);
      if(d>=monthStart && d<=monthEnd) transactions.push(t);
    }
  });
  // sort
  transactions.sort((a,b)=> a.date.localeCompare(b.date) || b.amount - a.amount);
}

/* get starting balance: override or compute */
async function getStartingBalance(year,month){
  const key = `${year}-${String(month).padStart(2,'0')}`;
  const doc = await db.collection('monthlyOverrides').doc(`${user.uid}_${key}`).get();
  if(doc.exists) return Number(doc.data().startingBalance)||0;
  // compute from transactions up to end of previous month
  const endPrev = new Date(year,month,0).toISOString().split('T')[0];
  const snap = await db.collection('transactions').where('uid','==',user.uid).where('date','<=',endPrev).get();
  let bal=0; snap.docs.forEach(d=>{ const tx=d.data(); bal += tx.type==='income'? Number(tx.amount): -Number(tx.amount); });
  return bal;
}

/* render everything */
function renderAll(){
  renderCalendar();
  renderSummaryAndChart();
  renderGoals();
  renderBudgets();
  renderInsights();
  computeAndDisplaySpendToday();
}

/* calendar UI */
function renderCalendar(){
  calendarGrid.innerHTML='';
  const year=currentDate.getFullYear(), month=currentDate.getMonth();
  monthLabel.textContent = currentDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const firstDay = new Date(year,month,1).getDay();
  const daysInMonth = new Date(year,month+1,0).getDate();
  // day names row (optional: skip to save space), create empty slots
  for(let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='day'; e.style.opacity='0'; calendarGrid.appendChild(e); }
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year,month,d); const iso=date.toISOString().split('T')[0];
    const cell = document.createElement('div'); cell.className='day'; cell.dataset.date=iso;
    cell.innerHTML = `<div class="num">${d}</div>`;
    // append tx pills for this date
    transactions.filter(t=>t.date===iso).forEach(t=>{
      const pill = document.createElement('div'); pill.className = 'transaction-pill '+t.type; pill.textContent = `${t.title} ${settings.currency}${Number(t.amount).toFixed(0)}`;
      pill.title = `${t.title} â€” ${settings.currency}${Number(t.amount).toFixed(2)}${t.isVirtual? ' (recurring)': ''}`;
      pill.addEventListener('click', (e)=>{ e.stopPropagation(); openTxModal(t); });
      cell.appendChild(pill);
    });
    cell.addEventListener('click', ()=> openTxModal({date:iso}));
    calendarGrid.appendChild(cell);
  }
}

/* Open transaction modal for add/edit */
function openTxModal(tx){
  document.getElementById('tx-form').reset();
  document.getElementById('tx-id').value = tx && tx.id ? tx.id : '';
  document.getElementById('tx-title-input').value = tx && tx.title ? tx.title : '';
  document.getElementById('tx-amount').value = tx && tx.amount ? tx.amount : '';
  document.getElementById('tx-cat').value = tx && tx.category ? tx.category : '';
  document.getElementById('tx-type').value = tx && tx.type ? tx.type : 'expense';
  document.getElementById('tx-date').value = tx && tx.date ? tx.date : new Date().toISOString().split('T')[0];
  document.getElementById('tx-rec').checked = tx && tx.isRecurring ? true : false;
  document.getElementById('tx-freq').value = tx && tx.recurrence ? tx.recurrence : 'monthly';
  document.getElementById('rec-opts').style.display = (tx && tx.isRecurring) ? 'block' : 'none';
  document.getElementById('tx-delete').style.display = tx && tx.id ? 'inline-block' : 'none';
  document.getElementById('tx-modal').style.display = 'flex';
}

/* render summary and chart */
function renderSummaryAndChart(){
  const start = Number(startEl.textContent.replace(/[^0-9\.-]/g,'')) || 0;
  // net flow this month (including virtual recurring)
  let income=0, expense=0;
  const todayISO = new Date().toISOString().split('T')[0];
  transactions.forEach(t=>{ if(t.type==='income') income += Number(t.amount); else expense += Number(t.amount); });
  const net = income - expense;
  netEl.textContent = `${settings.currency}${net.toFixed(2)}`;
  netEl.className = 'amount '+(net>=0?'positive':'negative');
  // predict daily balances
  const predicted = computeDailyPredicted(start);
  const final = predicted.length? predicted[predicted.length-1] : start;
  endEl.textContent = `${settings.currency}${final.toFixed(2)}`;
  endEl.className = 'amount '+(final>=0?'positive':'negative');
  // update chart (small inline sparkline could be added â€” omitted for brevity)
  // smooth number animation: pulse
  animateValueChange(endEl);
}

/* compute daily predicted balances array */
function computeDailyPredicted(startingBalance){
  const year=currentDate.getFullYear(), month=currentDate.getMonth();
  const daysInMonth = new Date(year,month+1,0).getDate();
  const monthStart = new Date(year,month,1); const monthEnd = new Date(year,month+1,0);
  // total budgets daily burn
  const totalBud = budgets.reduce((s,b)=> s + (Number(b.amount)||0), 0);
  const dailyBurn = totalBud ? totalBud / daysInMonth : 0;
  const arr=[]; let cur = startingBalance;
  for(let d=1; d<=daysInMonth; d++){
    const iso = new Date(year,month,d).toISOString().split('T')[0];
    let actualNet = 0;
    transactions.filter(t=>t.date===iso).forEach(t=> actualNet += (t.type==='income'? Number(t.amount) : -Number(t.amount)) );
    cur = cur - dailyBurn + actualNet;
    arr.push(Number(cur.toFixed(2)));
  }
  return arr;
}

/* compute predicted end balance after building transactions */
function computePredictedEnd(startingBalance){
  const arr = computeDailyPredicted(startingBalance);
  return arr.length ? arr[arr.length-1] : startingBalance;
}

/* render goals and budgets */
function renderGoals(){
  if(!goals.length){ document.getElementById('goals').innerHTML = '<div class="muted">No goals yet.</div>'; return; }
  document.getElementById('goals').innerHTML = goals.map(g=>`<div style="margin-bottom:8px"><strong>${g.name}</strong><div class="muted">${settings.currency}${Number(g.amount).toFixed(2)}</div></div>`).join('');
}
function renderBudgets(){
  if(!budgets.length){ document.getElementById('budgets').innerHTML = '<div class="muted">No budgets yet.</div>'; return; }
  document.getElementById('budgets').innerHTML = budgets.map(b=>`<div style="margin-bottom:8px"><strong>${b.category}</strong><div class="muted">${settings.currency}${Number(b.amount).toFixed(2)}</div></div>`).join('');
}

/* simple insights */
function renderInsights(){
  const lines=[];
  if(settings.enableAI){
    const final = Number(endEl.textContent.replace(/[^0-9\.-]/g,''))||0;
    if(final<0) lines.push(`Warning: predicted balance negative (${settings.currency}${final.toFixed(2)})`);
    // detect repeated tx
    const counts={};
    transactions.forEach(t=>{ const key = `${t.title}::${t.amount}`; counts[key]=(counts[key]||0)+1; });
    Object.entries(counts).forEach(([k,v])=>{ if(v>=2) lines.push(`Likely recurring: ${k.split('::')[0]} (${settings.currency}${Number(k.split('::')[1]).toFixed(2)})`); });
  } else lines.push('Predictions are disabled in settings.');
  document.getElementById('insights').innerHTML = lines.length ? lines.map(l=>`<div style="margin-bottom:6px">${l}</div>`).join('') : '<div class="muted">No insights this month.</div>';
}

/* compute and display spend today */
function computeAndDisplaySpendToday(){
  const start = Number(startEl.textContent.replace(/[^0-9\.-]/g,''))||0;
  const today = new Date(); const year=today.getFullYear(), month=today.getMonth(); const todayISO = today.toISOString().split('T')[0];
  // net up to today (inclusive)
  let netToToday = 0;
  transactions.filter(t=> t.date <= todayISO ).forEach(t=> netToToday += (t.type==='income'? Number(t.amount) : -Number(t.amount)) );
  const currentBalance = start + netToToday;
  // remaining savings target = target - amount already 'saved' this month.
  // define savedSoFar as positive cumulative net (can't be negative)
  const savedSoFar = Math.max(0, currentBalance);
  const remainingSavings = Math.max(0, settings.savingsTarget - savedSoFar);
  // upcoming bills = sum of expenses (including recurring) in future days this month (after today)
  const monthEnd = new Date(year,month+1,0).toISOString().split('T')[0];
  let upcomingBills = 0;
  transactions.filter(t=> t.date > todayISO && t.date <= monthEnd).forEach(t=> { if(t.type==='expense') upcomingBills += Number(t.amount); });
  // available pool = currentBalance - remainingSavings - upcomingBills
  const availablePool = currentBalance - remainingSavings - upcomingBills;
  const daysLeft = ( (new Date(year,month+1,0)).getDate() - today.getDate() ) + 1; // include today
  const perDay = daysLeft>0 ? (availablePool / daysLeft) : availablePool;
  // format and color
  spendEl.textContent = `${settings.currency}${perDay.toFixed(2)}`;
  spendEl.style.color = perDay < 0 ? 'var(--bad)' : (perDay < 20 ? 'var(--warn)' : 'var(--good)');
  // warning text
  if(perDay < 0) warnEl.textContent = 'âš ï¸ Overspending risk â€” adjust transactions or goals.'; else warnEl.textContent = '';
  // pulse animation
  animateValueChange(spendEl);
}

/* animate small pulse on numeric change */
function animateValueChange(el){
  el.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.02)' }, { transform: 'scale(1)'}], { duration: 300, easing: 'ease' });
}

/* highlight day cell */
function flashDay(dateISO, type){
  const cell = document.querySelector(`.day[data-date="${dateISO}"]`);
  if(!cell) return;
  const cls = type==='income' ? 'flash-income' : 'flash-expense';
  cell.classList.add(cls);
  setTimeout(()=> cell.classList.remove(cls), 1000);
}

/* helper to persist starting balance override inline */
document.getElementById('starting-card').addEventListener('click', async ()=>{
  if(!user) return alert('Sign in');
  const txt = startEl.textContent.replace(/[^0-9\.-]/g,''); const val = prompt('Set starting balance for this month:', txt);
  if(val===null) return;
  const n = Number(val);
  if(isNaN(n)) return alert('Invalid number');
  const year=currentDate.getFullYear(), month=currentDate.getMonth(); const key = `${year}-${String(month).padStart(2,'0')}`;
  await db.collection('monthlyOverrides').doc(`${user.uid}_${key}`).set({startingBalance:n});
  await fetchAll(true);
});

/* month navigation */
document.getElementById('prev-month').addEventListener('click', ()=> { currentDate.setMonth(currentDate.getMonth()-1); fetchAll(); });
document.getElementById('next-month').addEventListener('click', ()=> { currentDate.setMonth(currentDate.getMonth()+1); fetchAll(); });

/* when transactions change: listeners already call fetchAll(true) to persist next month start */
/* minor helper: when adding a transaction locally, flash day and update live without waiting long */
async function addTransactionLocalPreview(tx){
  // flash target date
  flashDay(tx.date, tx.type);
  await fetchAll(true);
}

/* Populate initial data on load */
async function loadSettings(){ if(!user) return; const doc = await db.collection('settings').doc(user.uid).get(); if(doc.exists) settings = {...settings, ...doc.data()}; }

/* initial fetch wrapper used after CRUD operations to ensure live updates */
// Exposed functions to be called after db writes have completed:
window.refreshDashboard = async ()=> await fetchAll(true);

/* also hook up tx create shortcut on entry */
// Already handled by modal submit which calls fetchAll(true)

/* finally, initial render when the page loads if user already signed in */
// nothing else here; auth state change will call fetchAll()

</script>
</body>
</html>
