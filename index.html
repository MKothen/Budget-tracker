<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        :root {
            --bg-primary: #111827; /* slate-900 */
            --bg-secondary: #1f2937; /* slate-800 */
            --border-color: #374151; /* slate-700 */
            --text-primary: #f3f4f6; /* gray-200 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent: #8b5cf6; /* violet-500 */
            --accent-hover: #7c3aed; /* violet-600 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 120px; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: rgba(31, 41, 55, 0.5); color: var(--text-secondary); }
        .modal, #auth-container { display: none; }
        .modal.active, #auth-container.active { display: flex; }
        #app-container.hidden { display: none; }
        .progress-bar { background-color: var(--border-color); border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; }
        .calendar-day { min-width: 0; }
        .transaction-list { overflow: hidden; }
        .transaction-item { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .input-field { background-color: #374151; border: 1px solid #4b5563; color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--accent); ring: 1; ring-color: var(--accent); }
        .card { background-color: var(--bg-secondary); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: #374151; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #4b5563; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Overlay -->
    <div id="auth-container" class="active fixed inset-0 bg-slate-900 items-center justify-center p-4">
        <div class="card p-8 w-full max-w-sm">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-white">Login</h2>
            <form id="auth-form">
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-400">Email</label><input type="email" id="email" class="input-field mt-1 block w-full px-3 py-2 rounded-md shadow-sm" required></div>
                <div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-400">Password</label><input type="password" id="password" class="input-field mt-1 block w-full px-3 py-2 rounded-md shadow-sm" required></div>
                <button type="submit" id="auth-button" class="w-full btn-primary py-2 px-4 rounded-md transition-colors">Login</button>
            </form>
            <p id="auth-error" class="text-red-400 text-sm mt-4 text-center"></p>
            <p class="text-sm text-center mt-4"><a href="#" id="auth-toggle" class="font-medium text-violet-400 hover:text-violet-300">Need an account? Sign up</a></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
         <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8 relative">
                <h1 class="text-3xl font-bold text-white">Finance Dashboard</h1>
                <p class="text-gray-400 mt-1">Your financial overview, simplified.</p>
                <button id="logout-button" class="absolute top-0 right-0 bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm transition-colors">Logout</button>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <main class="lg:col-span-2 card p-6">
                    <div id="calendar-container">
                        <div class="flex items-center justify-between mb-6"><button id="prev-month" class="btn-secondary px-3 py-1 rounded-md">&lt;</button><h2 id="current-month-year" class="text-xl font-semibold"></h2><button id="next-month" class="btn-secondary px-3 py-1 rounded-md">&gt;</button></div>
                        <div class="calendar-grid grid-cols-7 text-center font-semibold text-gray-400 text-sm mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                        <div id="calendar-body" class="calendar-grid border-t border-l border-slate-700"></div>
                    </div>
                </main>
                <aside class="space-y-8">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Monthly Summary</h3>
                        <div class="space-y-3"><div class="flex justify-between items-center"><span class="text-gray-400">Income:</span><span id="summary-income" class="font-bold text-green-400">€0.00</span></div><div class="flex justify-between items-center"><span class="text-gray-400">Expenses:</span><span id="summary-expenses" class="font-bold text-red-400">€0.00</span></div><hr class="border-slate-700"><div class="flex justify-between items-center text-lg"><span class="font-semibold">Net:</span><span id="summary-net" class="font-bold">€0.00</span></div><div class="flex justify-between items-center text-lg"><span class="font-semibold">Cash Flow:</span><span id="summary-cashflow" class="font-bold">€0.00</span></div></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Expense Breakdown</h3>
                        <div class="w-full h-56 flex items-center justify-center"><canvas id="expense-chart"></canvas></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Savings Goals</h3>
                        <div id="savings-goals-list" class="space-y-4"></div>
                        <button id="add-goal-btn" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Goal</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Monthly Budgets</h3>
                        <div id="recurring-expenses-list" class="space-y-4"></div>
                        <button id="add-budget-btn" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Budget</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Automatic Monthly Bills</h3>
                        <div id="automatic-bills-list" class="space-y-2"></div>
                         <button id="add-bill-btn" class="w-full mt-4 btn-secondary py-2 rounded-md text-sm">Add New Bill</button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Settings</h3>
                        <div class="space-y-4"><div><label for="hourly-rate" class="block text-sm font-medium text-gray-400 mb-1">Your Hourly Rate (€)</label><input type="number" id="hourly-rate" class="input-field w-full px-3 py-2 rounded-md shadow-sm" placeholder="e.g., 15.50" step="0.01"></div><div><label for="initial-balance" class="block text-sm font-medium text-gray-400 mb-1">Initial Balance (€)</label><input type="number" id="initial-balance" class="input-field w-full px-3 py-2 rounded-md shadow-sm" placeholder="e.g., 500.00" step="0.01"></div><button id="save-settings-btn" class="w-full btn-primary py-2 px-4 rounded-md transition-colors">Save Settings</button></div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 id="modal-title" class="text-xl font-semibold mb-6">Add Transaction</h3><form id="transaction-form"><input type="hidden" id="transaction-date"><input type="hidden" id="transaction-id"><div class="mb-4"><div class="flex rounded-md shadow-sm"><button type="button" id="type-income" class="flex-1 py-2 px-4 border border-slate-700 bg-slate-800 rounded-l-md focus:outline-none">Income</button><button type="button" id="type-expense" class="flex-1 py-2 px-4 border border-slate-700 bg-slate-800 rounded-r-md focus:outline-none -ml-px">Expense</button></div></div><div id="income-source-group" class="mb-4 hidden"><label class="block text-sm font-medium text-gray-400 mb-2">Income Type</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="income-source" value="other" class="focus:ring-violet-500 h-4 w-4 text-violet-600 bg-slate-700 border-slate-600" checked><span class="ml-2 text-sm">Fixed Amount</span></label><label class="flex items-center"><input type="radio" name="income-source" value="work" class="focus:ring-violet-500 h-4 w-4 text-violet-600 bg-slate-700 border-slate-600"><span class="ml-2 text-sm">Work (by hours)</span></label></div></div><div id="category-group" class="mb-4 hidden"><label for="category" class="block text-sm font-medium text-gray-400">Category</label><select id="category" class="input-field mt-1 block w-full px-3 py-2 rounded-md"></select></div><div class="mb-4"><label for="description" class="block text-sm font-medium text-gray-400">Description</label><input type="text" id="description" class="input-field mt-1 block w-full px-3 py-2 rounded-md" required></div><div id="amount-group" class="mb-4"><label for="amount" class="block text-sm font-medium text-gray-400">Amount (€)</label><input type="number" id="amount" class="input-field mt-1 block w-full px-3 py-2 rounded-md" step="0.01" required></div><div id="hours-group" class="mb-4 hidden"><label for="hours" class="block text-sm font-medium text-gray-400">Hours Worked</label><input type="number" id="hours" class="input-field mt-1 block w-full px-3 py-2 rounded-md" step="0.1"><p class="text-sm text-gray-500 mt-1">Calculated Income: <span id="calculated-income" class="font-semibold">€0.00</span></p></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="delete-transaction" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">Delete</button><button type="button" id="cancel-transaction" class="btn-secondary px-4 py-2 rounded-md">Cancel</button><button type="submit" id="save-transaction" class="btn-primary px-4 py-2 rounded-md">Save</button></div></form></div>
    </div>
    <div id="budget-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Budget</h3><form id="budget-form"><input type="hidden" id="budget-id"><div class="mb-4"><label for="budget-description" class="block text-sm font-medium text-gray-400">Description</label><input type="text" id="budget-description" placeholder="e.g., Groceries" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="budget-amount" class="block text-sm font-medium text-gray-400">Monthly Budget (€)</label><input type="number" id="budget-amount" placeholder="e.g., 300" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" class="btn-secondary px-4 py-2 rounded-md" id="cancel-budget">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md" id="save-budget-btn">Save Budget</button></div></form></div>
    </div>
    <div id="goal-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Savings Goal</h3><form id="goal-form"><input type="hidden" id="goal-id"><div class="mb-4"><label for="goal-description" class="block text-sm font-medium text-gray-400">Goal Name</label><input type="text" id="goal-description" placeholder="e.g., Vacation Fund" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="goal-amount" class="block text-sm font-medium text-gray-400">Target Amount (€)</label><input type="number" id="goal-amount" placeholder="e.g., 1000" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" class="btn-secondary px-4 py-2 rounded-md" id="cancel-goal">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md" id="save-goal-btn">Save Goal</button></div></form></div>
    </div>
    <div id="contribute-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Contribute to Goal</h3><form id="contribute-form"><input type="hidden" id="contribute-goal-id"><div class="mb-4"><label for="contribute-amount" class="block text-sm font-medium text-gray-400">Amount to Contribute (€)</label><input type="number" id="contribute-amount" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" class="btn-secondary px-4 py-2 rounded-md" id="cancel-contribute">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Contribute</button></div></form></div>
    </div>
    <div id="bill-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="card p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-6">Manage Automatic Bill</h3><form id="bill-form"><input type="hidden" id="bill-id"><div class="mb-4"><label for="bill-description" class="block text-sm font-medium text-gray-400">Bill Name</label><input type="text" id="bill-description" placeholder="e.g., Rent" class="input-field mt-1 w-full px-3 py-2 rounded-md" required></div><div class="mb-4"><label for="bill-amount" class="block text-sm font-medium text-gray-400">Amount (€)</label><input type="number" id="bill-amount" class="input-field mt-1 w-full px-3 py-2 rounded-md" step="0.01" required></div><div class="mb-4"><label for="bill-day" class="block text-sm font-medium text-gray-400">Day of Month</label><input type="number" id="bill-day" class="input-field mt-1 w-full px-3 py-2 rounded-md" min="1" max="31" required></div><div class="flex justify-end space-x-3 mt-8"><button type="button" class="btn-secondary px-4 py-2 rounded-md" id="cancel-bill">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md">Save Bill</button></div></form></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {"apiKey":"AIzaSyDzeI6mMuICNJdO_G2F7fiGFlQhyo8RWM8","authDomain":"budgeting-b3974.firebaseapp.com","projectId":"budgeting-b3974","storageBucket":"budgeting-b3974.appspot.com","messagingSenderId":"462817466291","appId":"1:462817466291:web:13260b80355f9d0b559dc6"};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentDate = dayjs();
        let transactions = {};
        let settings = { hourlyRate: '', initialBalance: 0, recurringExpenses: [], savingsGoals: [], automaticBills: [] };
        let currentUserId = null;
        let unsubscribeTransactions;
        let expenseChart = null;
        let isLoginMode = true;

        const $ = (selector) => document.getElementById(selector);

        // --- AUTH & INITIALIZATION ---
        onAuthStateChanged(auth, user => { if (user) { currentUserId = user.uid; $('auth-container').classList.remove('active'); $('app-container').classList.remove('hidden'); loadSettingsAndTransactions(); } else { $('auth-container').classList.add('active'); $('app-container').classList.add('hidden'); if (unsubscribeTransactions) unsubscribeTransactions(); currentUserId = null; transactions = {}; }});
        async function loadSettingsAndTransactions() { await loadSettings(); listenForTransactions(); }
        async function saveSettings() { if (!currentUserId) return; settings.hourlyRate = $('hourly-rate').value; settings.initialBalance = parseFloat($('initial-balance').value) || 0; const settingsRef = doc(db, 'users', currentUserId); await setDoc(settingsRef, { settings }, { merge: true });}
        async function loadSettings() { if (!currentUserId) return; const settingsRef = doc(db, 'users', currentUserId); const docSnap = await getDoc(settingsRef); if (docSnap.exists() && docSnap.data().settings) { const loaded = docSnap.data().settings; settings.hourlyRate = loaded.hourlyRate || ''; settings.initialBalance = loaded.initialBalance || 0; settings.recurringExpenses = loaded.recurringExpenses || []; settings.savingsGoals = loaded.savingsGoals || []; settings.automaticBills = loaded.automaticBills || []; $('hourly-rate').value = settings.hourlyRate; $('initial-balance').value = settings.initialBalance; } renderAll(); }
        
        function listenForTransactions() { if (!currentUserId) return; if (unsubscribeTransactions) unsubscribeTransactions(); const transCollectionRef = collection(db, 'users', currentUserId, 'transactions'); unsubscribeTransactions = onSnapshot(transCollectionRef, (snapshot) => { transactions = {}; snapshot.forEach(doc => { const t = { id: doc.id, ...doc.data() }; if (!transactions[t.date]) transactions[t.date] = []; transactions[t.date].push(t); }); renderAll(); }); }
        
        function renderAll() { renderCalendar(); updateSummaryAndCashFlow(); renderRecurringExpenses(); renderSavingsGoals(); renderAutomaticBills(); renderExpenseChart(); }

        async function renderCalendar() {
            await addAutomaticBillsForMonth(currentDate);
            const calendarBody = $('calendar-body'); calendarBody.innerHTML = ''; const month = currentDate.month(); const year = currentDate.year(); $('current-month-year').textContent = currentDate.format('MMMM YYYY'); const firstDayOfMonth = dayjs().year(year).month(month).startOf('month').day(); const daysInMonth = currentDate.daysInMonth(); const prevMonth = currentDate.subtract(1, 'month'); const daysInPrevMonth = prevMonth.daysInMonth(); let html = ''; for (let i = firstDayOfMonth; i > 0; i--) html += createDayCell(prevMonth.date(daysInPrevMonth - i + 1).format('YYYY-MM-DD'), true); for (let i = 1; i <= daysInMonth; i++) html += createDayCell(currentDate.date(i).format('YYYY-MM-DD')); const totalCells = firstDayOfMonth + daysInMonth; const nextMonthDays = (7 - (totalCells % 7)) % 7; const nextMonthDate = currentDate.add(1, 'month'); for (let i = 1; i <= nextMonthDays; i++) html += createDayCell(nextMonthDate.date(i).format('YYYY-MM-DD'), true); calendarBody.innerHTML = html; addCalendarEventListeners(); renderTransactionsOnCalendar();
        }
        function createDayCell(dateStr, isOtherMonth = false) { const day = dayjs(dateStr).date(); const today = dayjs().format('YYYY-MM-DD'); let dayClass = 'calendar-day relative p-2 border-r border-b border-slate-700'; if (isOtherMonth) dayClass += ' other-month'; else dayClass += ' hover:bg-slate-700 cursor-pointer'; const dayNumberHtml = dateStr === today ? `<div class="absolute top-1 right-1 text-xs sm:text-sm bg-violet-600 text-white rounded-full h-6 w-6 flex items-center justify-center font-semibold">${day}</div>` : `<div class="text-xs sm:text-sm text-right text-gray-400">${day}</div>`; return `<div class="${dayClass}" data-date="${dateStr}">${dayNumberHtml}<div class="transaction-list mt-8 text-xs space-y-1"></div></div>`; }
        function renderTransactionsOnCalendar() { document.querySelectorAll('.transaction-item').forEach(el => el.remove()); for (const date in transactions) { const dayCell = document.querySelector(`.calendar-day[data-date="${date}"]`); if (dayCell) { const list = dayCell.querySelector('.transaction-list'); transactions[date].forEach(t => { const item = document.createElement('div'); item.className = `transaction-item p-1 rounded text-white ${t.type === 'income' ? 'bg-green-600' : (t.category && t.category.startsWith('goal_') ? 'bg-blue-600' : 'bg-red-600')}`; item.textContent = `${t.description}: €${t.amount.toFixed(2)}`; item.title = `${t.description}: €${t.amount.toFixed(2)}`; item.dataset.id = t.id; item.dataset.date = date; list.appendChild(item); }); } } }

        function updateSummaryAndCashFlow() {
            const month = currentDate.month(), year = currentDate.year();
            let totalIncome = 0;
            const monthlyTransactions = Object.values(transactions).flat().filter(t => dayjs(t.date).month() === month && dayjs(t.date).year() === year);
            monthlyTransactions.forEach(t => { if (t.type === 'income') totalIncome += t.amount; });
            const totalBudgetedExpenses = (settings.recurringExpenses || []).reduce((acc, item) => acc + item.amount, 0);
            const oneTimeExpenses = monthlyTransactions.filter(t => t.type === 'expense' && t.category === 'one-time').reduce((acc, t) => acc + t.amount, 0);
            const totalExpenses = totalBudgetedExpenses + oneTimeExpenses;
            $('summary-income').textContent = `€${totalIncome.toFixed(2)}`;
            $('summary-expenses').textContent = `€${totalExpenses.toFixed(2)}`;
            const net = totalIncome - totalExpenses;
            const netSpan = $('summary-net'); netSpan.textContent = `€${net.toFixed(2)}`; netSpan.className = `font-bold ${net >= 0 ? 'text-green-400' : 'text-red-400'}`;
            let runningBalance = parseFloat(settings.initialBalance) || 0;
            Object.values(transactions).flat().sort((a,b) => dayjs(a.date).diff(dayjs(b.date))).forEach(t => { if (dayjs(t.date).isAfter(dayjs(), 'day')) return; runningBalance += t.type === 'income' ? t.amount : -t.amount; });
            const cashFlowSpan = $('summary-cashflow'); cashFlowSpan.textContent = `€${runningBalance.toFixed(2)}`; cashFlowSpan.className = `font-bold ${runningBalance >= 0 ? 'text-gray-200' : 'text-red-400'}`;
        }
        
        function renderExpenseChart() {
            const ctx = $('expense-chart').getContext('2d');
            const month = currentDate.month(), year = currentDate.year();
            const monthlyExpenses = Object.values(transactions).flat().filter(t => t.type === 'expense' && dayjs(t.date).month() === month && dayjs(t.date).year() === year);
            const expenseData = {};
            monthlyExpenses.forEach(t => {
                let categoryName = "One-Time";
                if(t.category !== 'one-time' && !t.category.startsWith('goal_')) { const budget = settings.recurringExpenses.find(b => b.id === t.category); if(budget) categoryName = budget.description; }
                else if (t.category && t.category.startsWith('goal_')) { const goal = settings.savingsGoals.find(g => g.id === t.category.split('_')[1]); if(goal) categoryName = `Goal: ${goal.description}`; }
                if (!expenseData[categoryName]) expenseData[categoryName] = 0; expenseData[categoryName] += t.amount;
            });
            if (expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(expenseData), datasets: [{ data: Object.values(expenseData), backgroundColor: ['#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#6366f1'], borderColor: '#1f2937', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
        }
        
        // --- MODAL & FORM LOGIC ---
        function setupEventListeners() {
            document.addEventListener('click', e => {
                const target = e.target.closest('button'); if(!target) return;
                if (target.matches('.edit-budget-btn')) openBudgetModal(target.dataset.id);
                if (target.matches('.delete-budget-btn')) { const id = target.dataset.id; if(confirm('Delete budget?')){ settings.recurringExpenses = settings.recurringExpenses.filter(i => i.id !== id); saveSettings().then(renderAll); }}
                if (target.matches('.edit-goal-btn')) openGoalModal(target.dataset.id);
                if (target.matches('.delete-goal-btn')) { const id = target.dataset.id; if(confirm('Delete goal?')){ settings.savingsGoals = settings.savingsGoals.filter(i => i.id !== id); saveSettings().then(renderAll); }}
                if (target.matches('.contribute-goal-btn')) openContributeModal(target.dataset.id);
                if (target.matches('.edit-bill-btn')) openBillModal(target.dataset.id);
                if (target.matches('.delete-bill-btn')) { const id = target.dataset.id; if(confirm('Delete bill?')){ settings.automaticBills = settings.automaticBills.filter(i => i.id !== id); saveSettings().then(renderAll); }}
            });
            $('add-budget-btn').addEventListener('click', () => openBudgetModal()); $('cancel-budget').addEventListener('click', () => $('budget-modal').classList.remove('active')); $('budget-form').addEventListener('submit', handleBudgetSubmit);
            $('add-goal-btn').addEventListener('click', () => openGoalModal()); $('cancel-goal').addEventListener('click', () => $('goal-modal').classList.remove('active')); $('goal-form').addEventListener('submit', handleGoalSubmit);
            $('add-bill-btn').addEventListener('click', () => openBillModal()); $('cancel-bill').addEventListener('click', () => $('bill-modal').classList.remove('active')); $('bill-form').addEventListener('submit', handleBillSubmit);
            $('cancel-contribute').addEventListener('click', () => $('contribute-modal').classList.remove('active')); $('contribute-form').addEventListener('submit', handleContributeSubmit);
            $('cancel-transaction').addEventListener('click', () => $('transaction-modal').classList.remove('active')); $('type-income').addEventListener('click', () => setTransactionType('income')); $('type-expense').addEventListener('click', () => setTransactionType('expense')); $('transaction-form').addEventListener('submit', handleTransactionSubmit); $('delete-transaction').addEventListener('click', handleDeleteTransaction);
            $('prev-month').addEventListener('click', () => { currentDate = currentDate.subtract(1, 'month'); renderAll(); }); $('next-month').addEventListener('click', () => { currentDate = currentDate.add(1, 'month'); renderAll(); });
            $('save-settings-btn').addEventListener('click', () => { saveSettings().then(() => alert('Settings Saved!')); });
            $('auth-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = $('email').value, password = $('password').value; $('auth-error').textContent = ''; try { if (isLoginMode) await signInWithEmailAndPassword(auth, email, password); else await createUserWithEmailAndPassword(auth, email, password); } catch (error) { $('auth-error').textContent = error.message; }});
            $('auth-toggle').addEventListener('click', (e) => { e.preventDefault(); isLoginMode = !isLoginMode; $('auth-title').textContent = isLoginMode ? 'Login' : 'Sign Up'; $('auth-button').textContent = isLoginMode ? 'Login' : 'Create Account'; $('auth-toggle').textContent = isLoginMode ? 'Need an account? Sign up' : 'Have an account? Login'; $('auth-error').textContent = ''; });
            $('logout-button').addEventListener('click', () => signOut(auth));
        }
        function handleTransactionSubmit(e) { e.preventDefault(); const date = $('transaction-date').value, id = $('transaction-id').value, description = $('description').value; let amount; let category = 'one-time', type = 'expense', hours = null, source = null; if ($('type-income').classList.contains('bg-violet-600')) { type = 'income'; source = document.querySelector('input[name="income-source"]:checked').value; if (source === 'work') { hours = parseFloat($('hours').value); amount = hours * (parseFloat(settings.hourlyRate) || 0); } else { amount = parseFloat($('amount').value); } } else { amount = parseFloat($('amount').value); category = $('category').value; } if (!description || isNaN(amount) || amount <= 0) return alert('Invalid input'); const newTransaction = { date, description, amount, type, category, hours, source }; const transCollectionRef = collection(db, 'users', currentUserId, 'transactions'); if (id) updateDoc(doc(transCollectionRef, id), newTransaction); else addDoc(transCollectionRef, newTransaction); $('transaction-modal').classList.remove('active'); }
        async function handleDeleteTransaction() { const id = $('transaction-id').value; if (confirm('Delete transaction?')) { await deleteDoc(doc(db, 'users', currentUserId, 'transactions', id)); $('transaction-modal').classList.remove('active'); }}
        function handleBudgetSubmit(e) { e.preventDefault(); const description = $('budget-description').value, amount = parseFloat($('budget-amount').value), id = $('budget-id').value || Date.now().toString(); if (!description || isNaN(amount) || amount <= 0) return alert('Invalid input'); const idx = settings.recurringExpenses.findIndex(i => i.id === id); if (idx > -1) settings.recurringExpenses[idx] = {id, description, amount}; else settings.recurringExpenses.push({id, description, amount}); saveSettings().then(() => { renderAll(); $('budget-modal').classList.remove('active'); }); }
        function handleGoalSubmit(e) { e.preventDefault(); const description = $('goal-description').value, amount = parseFloat($('goal-amount').value), id = $('goal-id').value || Date.now().toString(); if (!description || isNaN(amount) || amount <= 0) return alert('Invalid input'); const idx = settings.savingsGoals.findIndex(i => i.id === id); if (idx > -1) { settings.savingsGoals[idx].description = description; settings.savingsGoals[idx].target = amount; } else settings.savingsGoals.push({id, description, target: amount, saved: 0}); saveSettings().then(() => { renderAll(); $('goal-modal').classList.remove('active'); }); }
        function handleBillSubmit(e) { e.preventDefault(); const description = $('bill-description').value, amount = parseFloat($('bill-amount').value), day = parseInt($('bill-day').value), id = $('bill-id').value || Date.now().toString(); if (!description || isNaN(amount) || amount <= 0 || isNaN(day) || day < 1 || day > 31) return alert('Invalid input'); const idx = settings.automaticBills.findIndex(i => i.id === id); if (idx > -1) settings.automaticBills[idx] = {id, description, amount, day}; else settings.automaticBills.push({id, description, amount, day}); saveSettings().then(() => { renderAll(); $('bill-modal').classList.remove('active'); }); }
        function handleContributeSubmit(e) { e.preventDefault(); const goalId = $('contribute-goal-id').value, amount = parseFloat($('contribute-amount').value); if (isNaN(amount) || amount <= 0) return alert('Invalid amount'); const goal = settings.savingsGoals.find(g => g.id === goalId); if (!goal) return; const newTransaction = { date: dayjs().format('YYYY-MM-DD'), description: `Contribution to ${goal.description}`, amount, type: 'expense', category: `goal_${goalId}` }; addDoc(collection(db, 'users', currentUserId, 'transactions'), newTransaction); $('contribute-modal').classList.remove('active'); }
        function openModal(date, id = null) { $('transaction-modal').classList.add('active'); $('transaction-form').reset(); $('transaction-date').value = date; $('delete-transaction').classList.add('hidden'); let type = 'expense', category = 'one-time'; if (id) { const t = Object.values(transactions).flat().find(tr => tr.id === id); if (t) { $('modal-title').textContent = 'Edit Transaction'; $('transaction-id').value = id; $('description').value = t.description; $('amount').value = t.amount; type = t.type; category = t.category; $('delete-transaction').classList.remove('hidden'); } } else { $('modal-title').textContent = `Add Transaction for ${dayjs(date).format('MMMM D, YYYY')}`; } setTransactionType(type, category); }
        function openBudgetModal(id=null) { $('budget-form').reset(); $('budget-id').value = ''; if (id) { const b = settings.recurringExpenses.find(i => i.id === id); if (b) { $('budget-id').value = b.id; $('budget-description').value = b.description; $('budget-amount').value = b.amount; } } $('budget-modal').classList.add('active'); }
        function openGoalModal(id=null) { $('goal-form').reset(); $('goal-id').value = ''; if (id) { const g = settings.savingsGoals.find(i => i.id === id); if (g) { $('goal-id').value = g.id; $('goal-description').value = g.description; $('goal-amount').value = g.target; } } $('goal-modal').classList.add('active'); }
        function openBillModal(id=null) { $('bill-form').reset(); $('bill-id').value = ''; if (id) { const b = settings.automaticBills.find(i => i.id === id); if (b) { $('bill-id').value = b.id; $('bill-description').value = b.description; $('bill-amount').value = b.amount; $('bill-day').value = b.day; } } $('bill-modal').classList.add('active'); }
        function openContributeModal(id) { $('contribute-form').reset(); $('contribute-goal-id').value = id; $('contribute-modal').classList.add('active'); }
        function setTransactionType(type, category = 'one-time') { const incomeBtn = $('type-income'), expenseBtn = $('type-expense'); if (type === 'income') { incomeBtn.classList.add('bg-violet-600', 'text-white'); expenseBtn.classList.remove('bg-violet-600', 'text-white'); $('income-source-group').classList.remove('hidden'); $('category-group').classList.add('hidden'); } else { expenseBtn.classList.add('bg-violet-600', 'text-white'); incomeBtn.classList.remove('bg-violet-600', 'text-white'); $('income-source-group').classList.add('hidden'); $('category-group').classList.remove('hidden'); populateCategories(category); } }
        function populateCategories(selected) { const select = $('category'); select.innerHTML = '<option value="one-time">One-Time Expense</option>'; settings.recurringExpenses.forEach(item => { select.innerHTML += `<option value="${item.id}">${item.description}</option>`; }); select.value = selected; }
        
        async function addAutomaticBillsForMonth(date) { if(!currentUserId || !settings.automaticBills) return; const month = date.month(), year = date.year(); for(const bill of settings.automaticBills) { let billDay = bill.day > date.daysInMonth() ? date.daysInMonth() : bill.day; const billDate = date.date(billDay).format('YYYY-MM-DD'); const desc = `Auto-Bill: ${bill.description}`; const q = query(collection(db, 'users', currentUserId, 'transactions'), where("date", "==", billDate), where("description", "==", desc)); const existing = await getDocs(q); if(existing.empty) { addDoc(collection(db, 'users', currentUserId, 'transactions'), { date: billDate, description: desc, amount: bill.amount, type: 'expense', category: 'one-time' }); } } }
        function renderRecurringExpenses() { const list = $('recurring-expenses-list'); list.innerHTML = ''; if (!settings.recurringExpenses || !settings.recurringExpenses.length) return list.innerHTML = `<p class="text-sm text-center text-gray-400">No budgets set.</p>`; const monthlyTransactions = Object.values(transactions).flat().filter(t => dayjs(t.date).month() === currentDate.month() && dayjs(t.date).year() === currentDate.year()); settings.recurringExpenses.forEach(b => { const spent = monthlyTransactions.filter(t => t.category === b.id).reduce((acc, t) => acc + t.amount, 0); const p = b.amount > 0 ? (spent / b.amount) * 100 : 0; const c = p > 100 ? 'bg-red-500' : p > 75 ? 'bg-yellow-500' : 'bg-green-500'; list.innerHTML += `<div class="bg-slate-800 p-3 rounded-md"><div class="flex justify-between items-center mb-2"><p class="font-medium">${b.description}</p><div class="flex space-x-2"><button class="edit-budget-btn text-sm font-medium text-violet-400 hover:text-violet-300" data-id="${b.id}">Edit</button><button class="delete-budget-btn text-sm font-medium text-red-400 hover:text-red-300" data-id="${b.id}">Del</button></div></div><div class="text-sm text-gray-400 mb-2"><span>Spent: €${spent.toFixed(2)}</span> / <span>€${b.amount.toFixed(2)}</span></div><div class="progress-bar h-2 w-full"><div class="progress-bar-inner ${c}" style="width: ${Math.min(p, 100)}%;"></div></div></div>`; }); }
        function renderSavingsGoals() { const list = $('savings-goals-list'); list.innerHTML = ''; if (!settings.savingsGoals || !settings.savingsGoals.length) return list.innerHTML = `<p class="text-sm text-center text-gray-400">No goals set.</p>`; const allTransactions = Object.values(transactions).flat(); settings.savingsGoals.forEach(g => { const saved = allTransactions.filter(t => t.category === `goal_${g.id}`).reduce((acc, t) => acc + t.amount, 0); const p = g.target > 0 ? (saved / g.target) * 100 : 0; list.innerHTML += `<div class="bg-slate-800 p-3 rounded-md"><div class="flex justify-between items-center mb-2"><p class="font-medium">${g.description}</p><div class="flex space-x-2"><button class="contribute-goal-btn text-sm font-medium text-green-400 hover:text-green-300" data-id="${g.id}">Add</button><button class="edit-goal-btn text-sm font-medium text-violet-400 hover:text-violet-300" data-id="${g.id}">Edit</button><button class="delete-goal-btn text-sm font-medium text-red-400 hover:text-red-300" data-id="${g.id}">Del</button></div></div><div class="text-sm text-gray-400 mb-2"><span>Saved: €${saved.toFixed(2)}</span> / <span>€${g.target.toFixed(2)}</span></div><div class="progress-bar h-2 w-full"><div class="progress-bar-inner bg-blue-500" style="width: ${Math.min(p, 100)}%;"></div></div></div>`; }); }
        function renderAutomaticBills() { const list = $('automatic-bills-list'); list.innerHTML = ''; if (!settings.automaticBills || !settings.automaticBills.length) return list.innerHTML = `<p class="text-sm text-center text-gray-400">No bills set.</p>`; settings.automaticBills.forEach(b => { list.innerHTML += `<div class="flex justify-between items-center bg-slate-800 p-2 rounded-md text-sm"><p>${b.description} - €${b.amount} on day ${b.day}</p><div class="flex space-x-2"><button class="edit-bill-btn text-sm font-medium text-violet-400 hover:text-violet-300" data-id="${b.id}">Edit</button><button class="delete-bill-btn text-sm font-medium text-red-400 hover:text-red-300" data-id="${b.id}">Del</button></div></div>`; }); }

        setupEventListeners();
        addCalendarEventListeners();
    </script>
</body>
</html>






